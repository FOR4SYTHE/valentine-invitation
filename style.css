/* --- RESET & VARIABLES --- */
:root {
    --color-bg-dark: #8a1c28;
    --color-bg-light: #b33646; 
    --color-text: #fff0f0;
    --royal-cream: #f3e5dc; 
    --royal-brown: #4a2c2a; 
    --font-hand: 'Beth Ellen', cursive;
    --font-paint: 'Finger Paint', cursive;
    --font-lux: 'Playfair Display', serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; }

body {
    background-color: var(--color-bg-dark);
    color: var(--color-text);
    font-family: var(--font-lux);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden; 
    /* Prevent pull-to-refresh on mobile */
    overscroll-behavior: none; 
}

/* --- BACKGROUNDS --- */
#pattern-container {
    position: fixed; top: -100%; left: -100%; width: 300vw; height: 300vh;
    z-index: -2; transform: rotate(-15deg);
    display: flex; flex-wrap: wrap; align-content: center; justify-content: center;
    gap: 2rem; pointer-events: none;
}
.bg-text {
    font-family: var(--font-hand); font-size: 4.5rem; line-height: 1;
    color: rgba(255, 235, 238, 0.08); white-space: nowrap; user-select: none;
}
.bg-vignette {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, transparent 20%, var(--color-bg-dark) 130%);
    z-index: -1; pointer-events: none;
}
.noise-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: url('data:image/svg+xml;utf8,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.06"/%3E%3C/svg%3E');
    pointer-events: none; z-index: 0; 
}

/* --- PREMIUM INTRO OVERLAY (MACRO ZOOM) --- */
.intro-overlay {
    position: fixed; inset: 0; /* Safer than width/height for mobile */
    height: 100dvh; /* Dynamic viewport height to avoid jumpy URL bars */
    z-index: 9999;
    background: var(--royal-cream);
    transition: opacity 0.5s ease;
    touch-action: none; /* Disables browser gestures on overlay */
}

.envelope-full-screen {
    position: relative; width: 100%; height: 100%;
    perspective: 1500px;
    overflow: hidden;
    cursor: pointer;
    /* Optimize taps */
    touch-action: manipulation; 
    -webkit-tap-highlight-color: transparent;
}

/* The Paper Background */
.env-bg {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
    background: linear-gradient(to bottom, #f3e5dc 0%, #e6d0c0 100%);
    z-index: 1;
}

/* The Top Flap */
.env-flap {
    position: absolute; top: 0; left: 0; width: 100%; height: 50%;
    z-index: 5;
    transform-origin: top center;
    transform-style: preserve-3d;
    backface-visibility: hidden;
    filter: drop-shadow(0 15px 25px rgba(0,0,0,0.15));
    will-change: transform;
}

.flap-paper {
    width: 100%; height: 100%;
    background: linear-gradient(135deg, #fffbf7 0%, #f3e5dc 100%);
    clip-path: polygon(0 0, 100% 0, 50% 100%);
}

/* Wax Seal - Responsive Clamping */
.seal-container {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    /* Smart Sizing: Minimum 180px, Preferred 25vw, Max 300px */
    width: clamp(180px, 25vw, 300px); 
    height: clamp(180px, 25vw, 300px);
    z-index: 10;
    transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}
.seal-container:active { transform: translate(-50%, -50%) scale(0.95); }

.seal-img {
    width: 100%; height: 100%; object-fit: contain;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));
}

/* Split Seal Logic */
.seal-split-wrapper {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: none; 
}
.seal-part {
    position: absolute; top: 0; width: 100%; height: 100%;
    background-image: url('./assets/rose-stamp.webp');
    background-size: contain; background-repeat: no-repeat; background-position: center;
    will-change: transform, opacity;
}
.seal-part.left { clip-path: polygon(0 0, 45% 0, 55% 100%, 0 100%); }
.seal-part.right { clip-path: polygon(45% 0, 100% 0, 100% 100%, 55% 100%); }

/* Hint Text - Glowing Breath */
.intro-hint {
    position: absolute; bottom: 15%; width: 100%; text-align: center;
    font-family: var(--font-hand); color: #8a6a60;
    font-size: clamp(1.4rem, 4vw, 2rem); /* Responsive Font */
    letter-spacing: 2px;
    z-index: 20; pointer-events: none;
    animation: breathGlow 3s ease-in-out infinite;
}

@keyframes breathGlow { 
    0%, 100% { opacity: 0.7; text-shadow: 0 0 0px rgba(255,255,255,0); } 
    50% { opacity: 1; text-shadow: 0 0 15px rgba(255, 230, 230, 0.8), 0 0 30px rgba(255, 200, 200, 0.4); } 
}


/* --- STAGE & CARDS --- */
.stage {
    position: relative; z-index: 10;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    padding: 20px;
}

.card-wrapper {
    perspective: 1200px; position: relative;
    margin-bottom: 2rem;
    width: 100%; display: flex; justify-content: center;
    z-index: 10;
    min-height: 300px;
}

.card-composite {
    position: relative;
    width: 500px; height: 715px; 
    max-width: 85vw;
    aspect-ratio: 500 / 715; 
    height: auto;
    transform-style: preserve-3d; cursor: default;
}

.layer {
    position: absolute; width: 100%; height: 100%;
    object-fit: contain; pointer-events: none; will-change: transform;
}
.base { top: 0; left: 0; filter: drop-shadow(0 30px 60px rgba(0,0,0,0.5)); }
.cake { width: 80%; left: 10%; top: 5%; height: auto; z-index: 2; }
.text { width: 80%; left: 10%; top: 52%; height: auto; z-index: 3; }

/* --- CONTROLS --- */
.controls {
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    gap: 2rem; position: relative; z-index: 100; width: 100%;
    flex: 0 0 auto; padding-bottom: 2rem;
}

.btn-primary {
    position: relative; border: none; cursor: pointer;
    padding: 0.8rem 3rem; border-radius: 100px; 
    background: var(--royal-cream); color: var(--royal-brown);
    font-family: var(--font-lux); font-size: 1.6rem; font-weight: 700; font-style: italic; letter-spacing: 1px;
    box-shadow: inset 0 0 0 2px var(--royal-brown), inset 0 0 0 5px var(--royal-cream), 0 0 0 4px var(--royal-brown), 0 10px 30px rgba(0,0,0,0.4);
    z-index: 20; white-space: nowrap;
    touch-action: manipulation;
}
.btn-primary::before, .btn-primary::after { content: '‚ùß'; position: absolute; top: 50%; transform: translateY(-50%); font-size: 1.5rem; color: var(--royal-brown); opacity: 0.6; }
.btn-primary::before { left: 15px; } .btn-primary::after { right: 15px; transform: translateY(-50%) scaleX(-1); }
.btn-primary:hover { transform: translateY(-5px) scale(1.05); background: #fff; box-shadow: inset 0 0 0 2px var(--royal-brown), inset 0 0 0 5px #fff, 0 0 0 4px var(--royal-brown), 0 0 0 8px rgba(255,255,255,0.2), 0 20px 50px rgba(0,0,0,0.5); }

.btn-secondary {
    position: relative; background: #3e2723; border: 2px dashed #5d4037; cursor: pointer;
    width: 70px; height: 40px; border-radius: 20px;
    display: flex; justify-content: center; align-items: center;
    z-index: 10; flex-shrink: 0;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.2s;
    touch-action: manipulation;
}
.sock-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
.sock-icon { height: 100%; width: auto; object-fit: contain; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); transition: filter 0.3s; position: absolute; z-index: 2; }
.stink-aura { position: absolute; width: 150%; height: 150%; top: -25%; left: -25%; border-radius: 50%; background: radial-gradient(circle closest-side at center, rgba(140, 255, 0, 0.5) 0%, transparent 100%); opacity: 0; pointer-events: none; z-index: 1; mix-blend-mode: hard-light; filter: blur(8px); }

/* --- ASSETS & ANIMATIONS --- */
.fly { position: absolute; width: 0; height: 0; pointer-events: none; z-index: 20; will-change: transform; }
.fly-visual { width: 4px; height: 6px; background: #000; border-radius: 50%; position: relative; }
.fly-wing { position: absolute; top: -2px; width: 6px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; animation: flap 0.05s infinite alternate; }
.fly-wing.left { left: -3px; transform-origin: right center; } .fly-wing.right { right: -3px; transform-origin: left center; }
@keyframes flap { from { transform: rotate(0deg) scaleY(1); } to { transform: rotate(40deg) scaleY(0.4); } }

.particle { position: absolute; border-radius: 50%; pointer-events: none; z-index: 100; will-change: transform; }
.ember { background: #ff4500; box-shadow: 0 0 5px #ff8800; mix-blend-mode: screen; } .smoke { background: #333; opacity: 0.8; } .ash { background: #111; border-radius: 1px; }

.fart-cloud {
    position: absolute; width: 20px; height: 20px;
    background: #4b6b2f; border-radius: 50%; filter: blur(5px);
    opacity: 0; pointer-events: none; z-index: 5;
}

#flood-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-bg-dark); opacity: 0; pointer-events: none; z-index: 998; }
#heart-flood-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; overflow: hidden; }
.flood-heart { 
    position: absolute; bottom: -20%; opacity: 1; background-color: #ff3d57; 
    mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>') no-repeat center / contain;
    -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>') no-repeat center / contain;
    will-change: transform;
}

.screen { display: none; } .screen.active { display: block; }
.success-content { text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; z-index: 200; display: flex; flex-direction: column; align-items: center; gap: 2rem; visibility: hidden; }
.pinned-image { width: 500px; max-width: 85vw; height: auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: rotate(-2deg); }
.celebration-text { font-family: var(--font-hand); font-size: 2.5rem; color: #fff; text-shadow: 0 0 20px rgba(255, 100, 100, 0.5); line-height: 1.2; }
.valentines-text { font-family: var(--font-paint); font-size: 3.5rem; display: block; margin-top: 0.5rem; }
.beating-heart { display: inline-block; animation: heartBeat 1.2s infinite ease-in-out; }
@keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.3); } 100% { transform: scale(1); } }
.petal { position: absolute; top: -10%; border-radius: 2px 50% 30% 50%; background: linear-gradient(135deg, #ff3d57, #a3001e); box-shadow: 1px 1px 5px rgba(0,0,0,0.2); pointer-events: none; z-index: 50; }

/* --- RESPONSIVE FIXES --- */
@media (max-width: 768px) {
    .bg-text { font-size: 3rem; } 
    .stage { justify-content: space-between; padding-bottom: 40px; }
    
    .card-wrapper { flex: 1; min-height: 0; display: flex; align-items: center; max-height: 60vh; }
    .card-composite { 
        width: min(90vw, calc(60vh * (500/715))) !important;
        height: auto !important;
        aspect-ratio: 500 / 715;
        max-width: none;
    }
    .controls { gap: 1.5rem; margin-top: 0; flex-shrink: 0; }
    .btn-primary { padding: 0.8rem 2.5rem; font-size: 1.4rem; }
    .celebration-text { font-size: 2.2rem; } .valentines-text { font-size: 3rem; } .pinned-image { max-width: 90vw; }
}